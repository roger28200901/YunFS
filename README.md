# Yun File System

一個專業級的文件系統 CLI 工具，包含虛擬文件系統和類似 vim 的文本編輯器功能。採用模組化架構，注重安全性和代碼質量。文件系統使用 ChaCha20 加密存檔。

## 項目結構

項目採用模組化設計，代碼組織如下：

```
├── main.c                    # 主程序入口
├── Makefile                  # 構建配置
├── README.md                 # 說明文檔
│
└── src/                      # 核心源代碼目錄
    ├── core/                 # 核心功能模組
    │   ├── buffer.c/h        # 文本緩衝區管理（多文件編輯）
    │   ├── editor.c/h        # 編輯器核心（模式切換、命令處理）
    │   ├── command.c/h       # 命令解析和執行
    │   └── shell.c/h         # Shell 介面（ls, mkdir, cd 等命令）
    │
    ├── filesystem/           # 文件系統模組
    │   ├── vfs.c/h           # 虛擬文件系統（記憶體中）
    │   ├── vfs_persist.c/h   # VFS 持久化（ChaCha20 加密）
    │   ├── fileops.c/h       # 實際文件操作（安全封裝）
    │   └── path.c/h          # 路徑處理和驗證
    │
    ├── ui/                   # 用戶界面模組
    │   ├── startup/          # 啟動畫面相關
    │   │   ├── colors.h      # 顏色定義
    │   │   ├── terminal.c/h # 終端操作
    │   │   ├── title.c/h     # 標題顯示
    │   │   ├── menu.c/h      # 菜單顯示
    │   │   └── status.c/h    # 狀態欄顯示
    │   ├── screen.c/h        # 屏幕渲染和刷新（編輯器）
    │   ├── input.c/h         # 輸入處理（原始模式）
    │   └── status.c/h        # 狀態欄和消息顯示（編輯器內）
    │
    ├── security/             # 安全模組
    │   ├── chacha20.c/h      # ChaCha20 加密/解密
    │   ├── validation.c/h   # 輸入驗證
    │   └── sanitize.c/h       # 路徑清理和規範化
    │
    └── utils/                # 工具模組
        ├── error.c/h         # 錯誤處理
        └── memory.c/h        # 記憶體管理封裝
```

## 編譯

```bash
make
```

## 運行

### Shell 模式（預設）

```bash
# 啟動文件系統 shell
./yun-fs

# 在 shell 中可以使用以下命令：
# ls, cd, pwd, mkdir, touch, cat, echo, rm, mv, cp, clear, help, exit
```

### 編輯器模式

```bash
# 使用編輯器打開檔案
./yun-fs <檔案名稱>

# 例如
./yun-fs test.txt
```

## 核心功能與實現

### 1. 虛擬文件系統 (VFS)

#### 實現架構

虛擬文件系統採用**樹狀結構**實現，每個節點代表一個檔案或目錄：

- **節點結構**: 使用鏈結串列管理子節點和兄弟節點
- **路徑解析**: 自動處理絕對路徑和相對路徑
- **目錄導航**: 支援 `cd`、`pwd` 等目錄操作
- **檔案操作**: 支援檔案的建立、讀取、寫入、刪除、移動、複製

#### 核心特性

- **記憶體中運行**: 所有操作都在記憶體中進行，效能極高
- **樹狀結構**: 使用 `vfs_node_t` 結構實現階層式檔案系統
- **自動路徑處理**: 自動建立中間目錄，支援路徑規範化
- **時間戳記**: 自動記錄檔案的建立時間和修改時間

#### 數據結構

```c
typedef struct vfs_node {
    char *name;                    // 節點名稱
    vfs_node_type_t type;          // 檔案或目錄
    void *data;                    // 檔案內容（目錄為 NULL）
    size_t size;                   // 大小
    time_t mtime;                  // 修改時間
    time_t ctime;                  // 建立時間
    struct vfs_node *parent;       // 父節點
    struct vfs_node *children;     // 子節點鏈結串列
    struct vfs_node *next;         // 兄弟節點
} vfs_node_t;
```

### 2. Shell 命令介面

#### 實現方式

Shell 採用**表驅動架構**，所有命令統一註冊到命令表中：

- **命令分派**: 使用函數指標陣列實現命令路由
- **參數解析**: 自動將命令字串解析為 argc/argv 格式
- **歷史記錄**: 支援命令歷史記錄（最多 100 條）
- **命令補全**: 支援 Tab 鍵自動補全（基礎實現）

#### 支援的命令

- **檔案系統導航**: `ls`, `cd`, `pwd`
- **檔案/目錄操作**: `mkdir`, `touch`, `cat`, `rm`, `mv`, `cp`
- **文字處理**: `echo`（支援重定向 `>`）
- **系統命令**: `clear`, `help`, `history`, `exit`
- **編輯器整合**: `vim <檔案>` 可直接啟動編輯器

#### 命令執行流程

1. 讀取使用者輸入
2. 解析命令和參數
3. 查詢命令表找到對應處理函數
4. 執行命令處理函數
5. 記錄命令到歷史
6. 顯示執行結果

### 3. Vim 風格編輯器

#### 架構設計

編輯器採用**多模式架構**，仿照 Vim 的設計理念：

- **模式系統**: Normal、Insert、Visual、Command 四種模式
- **緩衝區管理**: 支援多檔案同時編輯（多緩衝區）
- **雙向鏈結串列**: 使用鏈結串列儲存文字行，支援高效插入/刪除

#### 核心功能實現

##### Normal 模式

- **移動操作**: `h/j/k/l`（方向鍵）、`w/b/e`（單詞移動）、`0/$`（行首行尾）
- **編輯操作**: `x`（刪除字元）、`dd`（刪除行）、`dw`（刪除單詞）
- **複製貼上**: `yy`（複製行）、`yw`（複製單詞）、`p/P`（貼上）
- **撤銷重做**: `u`（撤銷）、`Ctrl+r`（重做）
- **搜尋功能**: `/pattern`（向前搜尋）、`?pattern`（向後搜尋）、`n/N`（下一個/上一個）

##### Insert 模式

- **文字輸入**: 直接輸入文字
- **特殊操作**: `Backspace`（刪除）、`Enter`（換行）、`Esc`（返回 Normal）

##### Visual 模式

- **選取模式**: 字元選取（`v`）、行選取（`V`）、區塊選取（`Ctrl+v`）
- **選取操作**: 選取後可執行刪除、複製等操作

##### Command 模式

- **檔案操作**: `:w`（儲存）、`:w <檔名>`（另存為）、`:q`（退出）、`:wq`（儲存並退出）
- **緩衝區管理**: `:e <檔名>`（開啟檔案）、`:b <n>`（切換緩衝區）
- **搜尋替換**: `:s/old/new/`（替換，基礎實現）

#### 緩衝區實現

使用**雙向鏈結串列**儲存文字行，每行獨立管理記憶體：

```c
typedef struct line {
    char *text;              // 行內容
    size_t length;           // 行長度
    size_t capacity;         // 記憶體容量
    struct line *next;       // 下一行
    struct line *prev;       // 上一行
} line_t;
```

#### Vim 進階功能

- **撤銷系統**: 使用雙向鏈結串列記錄操作歷史
- **暫存器系統**: 支援 a-z 共 26 個具名暫存器
- **操作組合**: 支援 `d`（刪除）+ `w`（單詞）= `dw` 等組合操作
- **重複次數**: 支援 `3dd`（刪除 3 行）等重複操作

### 4. 文件系統加密

#### ChaCha20 加密實現

- **流密碼算法**: 使用 ChaCha20 流密碼進行對稱加密
- **密鑰衍生**: 從字串密鑰自動衍生 32 位元組密鑰
- **Nonce 管理**: 使用 12 位元組 nonce 確保每次加密的唯一性
- **對稱操作**: 加密和解密使用相同的 XOR 操作

#### 持久化流程

1. **序列化**: 將 VFS 樹狀結構序列化為位元組流
2. **加密**: 使用 ChaCha20 加密序列化數據
3. **儲存**: 寫入 `.yunfs_data` 檔案（包含魔數和版本號）
4. **載入**: 讀取檔案、解密、反序列化還原 VFS

#### 安全特性

- **固定密鑰**: 目前使用固定密鑰 "yunhongisbest"（可擴展為使用者輸入）
- **自動保存**: Shell 退出時自動加密保存
- **自動載入**: 啟動時自動解密載入（若檔案存在）

### 5. 安全機制

#### 輸入驗證

- **字串長度檢查**: 防止緩衝區溢位
- **字元有效性檢查**: 過濾危險字元，防止注入攻擊
- **緩衝區邊界檢查**: 確保所有記憶體存取在安全範圍內
- **檔案名稱驗證**: 檢查檔案名稱是否符合安全規範

#### 路徑安全

- **路徑遍歷檢測**: 自動偵測並阻止 `../` 等路徑遍歷攻擊
- **路徑規範化**: 移除重複斜線、處理 `.` 和 `..`
- **安全路徑連接**: 安全地連接基礎路徑和相對路徑
- **路徑長度限制**: 遵循 POSIX 標準（最大 4096 字元）

#### 記憶體安全

- **安全字串函數**: 使用 `strnlen`、`snprintf`、`strncpy` 等安全函數
- **記憶體管理封裝**: 統一的記憶體分配/釋放介面
- **記憶體清除**: 敏感資料釋放時自動清除內容
- **錯誤處理**: 所有記憶體操作都有錯誤檢查

## 功能特性

### Shell 命令

啟動程序後會進入一個類似作業系統的 shell 介面，支持以下命令：

- `ls [目錄]` - 列出目錄內容
- `cd [目錄]` - 切換目錄
- `pwd` - 顯示當前目錄路徑
- `mkdir <目錄>` - 創建目錄
- `touch <檔案>` - 創建檔案
- `cat <檔案>` - 顯示檔案內容
- `echo [文本]` - 輸出文本（支持 `echo text > file` 重定向）
- `rm <路徑>` - 刪除檔案或目錄
- `mv <源> <目標>` - 移動/重命名檔案或目錄
- `cp <源> <目標>` - 複製檔案
- `vim <檔案>` - 使用編輯器打開檔案
- `clear` - 清屏
- `history` - 顯示命令歷史
- `help` - 顯示幫助信息
- `exit` - 退出 shell

### Vim 風格編輯器

類似 vim 的文本編輯器，支持：

#### Normal 模式（預設模式）

- **移動**: `h/j/k/l`（方向）、`w/b/e`（單詞）、`0/$`（行首行尾）、`gg/G`（跳轉行）
- **編輯**: `x`（刪除字元）、`dd`（刪除行）、`dw`（刪除單詞）、`yy`（複製行）、`p/P`（貼上）
- **模式切換**: `i`（插入）、`a`（在後插入）、`v`（可視模式）、`:`（命令模式）
- **撤銷重做**: `u`（撤銷）、`Ctrl+r`（重做）
- **搜尋**: `/pattern`（向前）、`?pattern`（向後）、`n/N`（下一個/上一個）

#### Insert 模式

- 直接輸入文本
- `Enter`: 換行
- `Backspace`: 刪除字元
- `Esc`: 返回 Normal 模式

#### Command 模式

支持以下 vim 命令：

- `:w` - 保存檔案
- `:w <檔名>` - 另存為
- `:q` - 退出編輯器（如果有未保存的修改會提示）
- `:q!` - 強制退出（不保存）
- `:wq` - 保存並退出
- `:e <檔名>` - 打開檔案
- `:b <n>` - 切換緩衝區（n 為緩衝區編號）
- `:s/old/new/` - 搜尋並替換（基礎實現）

#### Visual 模式

- `v` - 字元選取模式
- `V` - 行選取模式
- `Ctrl+v` - 區塊選取模式（基礎實現）
- 選取後可執行刪除、複製等操作
- `Esc`: 返回 Normal 模式

## 使用範例

### Shell 模式

```bash
$ ./yun-fs
Yun File System Shell
輸入 'help' 查看可用命令

/ yun-fs$ mkdir test
/ yun-fs$ cd test
/test yun-fs$ touch file.txt
/test yun-fs$ echo "Hello World" > file.txt
/test yun-fs$ cat file.txt
Hello World
/test yun-fs$ cd ..
/ yun-fs$ ls
test/
/ yun-fs$ exit
```

### 編輯器模式

```bash
# 編輯檔案
./yun-fs test.txt

# 在編輯器中
# 1. 按 i 進入插入模式
# 2. 輸入文本
# 3. 按 Esc 返回 Normal 模式
# 4. 輸入 :wq 保存並退出
```

## 模組說明

### 核心模組 (core/)

#### buffer.c/h - 文字緩衝區管理

- **資料結構**: 使用雙向鏈結串列儲存文字行
- **功能**: 行的插入/刪除、字元的插入/刪除、檔案載入/儲存
- **特性**: 支援修改標記、唯讀模式、行號管理
- **記憶體管理**: 每行獨立管理記憶體，支援動態擴展

#### editor.c/h - 編輯器核心

- **模式管理**: Normal、Insert、Visual、Command 四種模式
- **緩衝區管理**: 支援多檔案同時編輯，緩衝區切換
- **輸入處理**: 根據模式分派按鍵處理
- **主迴圈**: 初始化終端、進入互動式編輯迴圈

#### command.c/h - 命令解析器

- **命令解析**: 解析 Vim 風格命令（`:w`、`:q`、`:e` 等）
- **參數提取**: 自動提取命令參數（檔案名稱、緩衝區編號等）
- **強制標記**: 支援 `!` 修飾符（如 `:q!`）
- **命令類型**: 定義所有支援的命令類型列舉

#### shell.c/h - Shell 介面

- **命令分派**: 表驅動的命令路由系統
- **歷史記錄**: 命令歷史管理（最多 100 條）
- **參數解析**: 將命令字串解析為 argc/argv 格式
- **生命週期**: Shell 建立、執行、銷毀

#### shell_commands.c/h - Shell 命令實現

- **檔案系統命令**: `ls`、`cd`、`pwd`、`mkdir`、`touch`、`cat`
- **檔案操作**: `rm`、`mv`、`cp`、`echo`（支援重定向）
- **系統命令**: `clear`、`help`、`history`、`exit`
- **編輯器整合**: `vim <檔案>` 命令

#### shell_completion.c/h - 命令補全

- **Tab 補全**: 基礎的命令和檔案名稱補全
- **終端控制**: 處理 Tab 鍵和方向鍵選擇

#### vim_ops.c/h - Vim 進階功能

- **撤銷/重做**: 雙向鏈結串列記錄操作歷史
- **暫存器系統**: a-z 共 26 個具名暫存器
- **Visual 模式**: 字元、行、區塊三種選取模式
- **搜尋功能**: 向前/向後搜尋、循環搜尋
- **文字物件**: 單詞、行等文字物件操作

### 文件系統模組 (filesystem/)

#### vfs.c/h - 虛擬文件系統

- **樹狀結構**: 使用 `vfs_node_t` 實現階層式檔案系統
- **節點操作**: 建立、刪除、尋找、重新命名、移動節點
- **檔案操作**: 讀取、寫入檔案內容
- **目錄操作**: 列出目錄內容、取得完整路徑

#### vfs_persist.c/h - VFS 持久化

- **序列化**: 將 VFS 樹狀結構轉換為位元組流
- **加密儲存**: 使用 ChaCha20 加密後寫入檔案
- **解密載入**: 從加密檔案讀取並還原 VFS
- **檔案格式**: 包含魔數、版本號、加密資料

#### fileops.c/h - 檔案操作封裝

- **安全封裝**: 所有檔案操作都經過安全檢查
- **權限驗證**: 檢查檔案權限和存在性
- **錯誤處理**: 統一的錯誤處理介面

#### path.c/h - 路徑處理

- **路徑解析**: 解析絕對路徑和相對路徑
- **路徑操作**: `dirname`、`basename` 等路徑工具函數
- **路徑驗證**: 檢查路徑有效性和安全性

### 安全模組 (security/)

#### chacha20.c/h - ChaCha20 加密

- **核心算法**: 實現 ChaCha20 流密碼算法
- **密鑰衍生**: 從字串密鑰衍生 32 位元組密鑰
- **加密/解密**: 對稱加密操作（XOR）
- **狀態管理**: 管理加密狀態（密鑰、nonce、計數器）

#### validation.c/h - 輸入驗證

- **字串驗證**: 長度檢查、字元有效性檢查
- **緩衝區驗證**: 邊界檢查，防止溢位
- **數值驗證**: 範圍檢查
- **檔案名稱驗證**: 檔案名稱安全規範檢查

#### sanitize.c/h - 路徑清理

- **路徑清理**: 移除危險字元
- **路徑規範化**: 移除重複斜線、處理 `.` 和 `..`
- **路徑遍歷檢測**: 偵測並阻止路徑遍歷攻擊
- **安全連接**: 安全地連接路徑

### UI 模組 (ui/)

#### screen.c/h - 螢幕渲染

- **終端控制**: 使用 ANSI Escape Sequences 控制終端
- **內容渲染**: 根據緩衝區內容繪製螢幕
- **游標控制**: 設定游標位置、隱藏/顯示游標
- **狀態列**: 顯示狀態訊息和命令列
- **捲動支援**: 處理大檔案的視窗捲動

#### input.c/h - 輸入處理

- **原始模式**: 設定終端為原始模式（Raw Mode）
- **按鍵讀取**: 逐字元讀取按鍵輸入
- **Escape 序列**: 解析方向鍵、功能鍵等 Escape 序列
- **命令列輸入**: 讀取一行輸入（支援 Backspace、Ctrl+U）

#### colors.h - 顏色定義

- **ANSI 顏色碼**: 定義終端機顏色常數
- **顏色工具**: 提供顏色設定和重置函數

#### splash.c/h - 啟動畫面

- **啟動顯示**: 顯示程式啟動畫面和標題
- **歡迎訊息**: 顯示歡迎訊息和基本資訊

### 工具模組 (utils/)

#### error.c/h - 錯誤處理

- **錯誤碼定義**: 統一的錯誤碼列舉
- **錯誤訊息**: 錯誤碼對應的錯誤訊息
- **錯誤設定/清除**: 全域錯誤狀態管理

#### memory.c/h - 記憶體管理

- **安全分配**: 記憶體分配封裝（自動檢查 NULL）
- **記憶體清除**: 釋放時清除敏感資料
- **記憶體工具**: 提供記憶體操作工具函數

## 架構設計

### 模組化設計

專案採用**高度模組化**的架構，每個模組職責單一、介面清晰：

- **分層架構**: UI 層、核心層、文件系統層、安全層、工具層
- **依賴管理**: 上層模組依賴下層模組，避免循環依賴
- **介面抽象**: 使用標頭檔定義清晰的公共介面
- **封裝性**: 內部實作細節隱藏在 `.c` 檔案中

### 設計模式

- **表驅動**: Shell 命令使用函數指標表實現路由
- **狀態機**: 編輯器模式切換使用狀態機模式
- **鏈結串列**: 文字緩衝區和撤銷系統使用鏈結串列
- **樹狀結構**: 虛擬文件系統使用樹狀結構

### 資料流

1. **Shell 模式**: 使用者輸入 → 命令解析 → 命令分派 → VFS 操作 → 結果顯示
2. **編輯器模式**: 按鍵輸入 → 模式處理 → 緩衝區操作 → 螢幕渲染 → 狀態更新
3. **持久化流程**: VFS 序列化 → ChaCha20 加密 → 檔案寫入

## 代碼質量標準

1. **模組化**: 每個模組職責單一，接口清晰，依賴關係明確
2. **錯誤處理**: 所有函數都有返回值檢查，統一的錯誤處理機制
3. **文檔**: 所有公共函數都有完整的繁體中文文檔註釋
4. **安全**: 所有用戶輸入都經過驗證，防止緩衝區溢出和路徑遍歷攻擊
5. **代碼風格**: 遵循一致的命名規範和代碼風格（CamelCase 用於類型，snake_case 用於函數）
6. **記憶體安全**: 使用安全字串函數，所有記憶體操作都有邊界檢查
7. **加密**: 文件系統數據使用 ChaCha20 加密存檔，確保資料安全

## 清理

```bash
make clean
```

## 技術棧

### 程式語言與標準

- **C11 標準**: 使用 C11 標準編寫，確保跨平台相容性
- **POSIX 相容**: 遵循 POSIX 標準，支援 Unix/Linux/macOS 系統

### 系統 API

- **termios**: 用於終端機原始模式設定（Raw Mode）
  - `tcgetattr` / `tcsetattr`: 取得/設定終端屬性
  - 關閉回顯（ECHO）和規範模式（ICANON）
  - 逐字元讀取輸入，支援即時按鍵響應

- **POSIX I/O**: 檔案操作和系統呼叫
  - `getline`: 安全讀取一行文字（動態分配記憶體）
  - `read` / `write`: 低階檔案 I/O
  - `stat`: 檔案屬性查詢

- **信號處理**: `signal` / `SIGINT` / `SIGTERM`
  - 處理 Ctrl+C 中斷，確保資料正確保存

### 終端控制

- **ANSI Escape Sequences**: 用於終端機控制
  - 游標控制: `\033[H]`（移動到左上角）、`\033[2J`（清屏）
  - 顏色輸出: `\033[31m`（紅色）、`\033[0m`（重置）
  - 游標隱藏/顯示: `\033[?25l` / `\033[?25h`

- **終端尺寸偵測**: 使用 `ioctl` 或環境變數取得終端大小

### 加密算法

- **ChaCha20 流密碼**: 高效能的對稱加密算法
  - 32 位元組密鑰
  - 12 位元組 nonce（一次性數值）
  - 64 位元組狀態矩陣
  - 20 輪加密運算（ChaCha20）

### 資料結構

- **雙向鏈結串列**: 用於文字緩衝區和撤銷系統
  - 高效的插入/刪除操作（O(1)）
  - 支援前向和後向遍歷

- **樹狀結構**: 用於虛擬文件系統
  - 節點包含父指標、子節點鏈結串列、兄弟節點鏈結串列
  - 支援階層式檔案系統操作

- **動態陣列**: 用於命令參數和目錄列表
  - 自動擴展容量
  - 記憶體安全管理

### 構建系統

- **Make**: 自動化編譯和連結
  - 自動搜尋所有 `.c` 檔案
  - 自動產生 include 路徑
  - 支援平行編譯（可選）
  - 清理目標（`make clean`）

### 開發工具

- **編譯器**: GCC（支援 C11）
- **除錯工具**: GDB（可選）
- **記憶體檢查**: Valgrind（可選，用於檢測記憶體洩漏）
- **靜態分析**: 可選使用 clang-tidy、cppcheck 等工具

### 依賴項目

本專案**無外部依賴**，僅使用標準 C 函式庫：
- `stdio.h`: 標準輸入輸出
- `stdlib.h`: 記憶體管理和工具函數
- `string.h`: 字串操作
- `time.h`: 時間戳記
- `termios.h`: 終端控制（POSIX）
- `unistd.h`: POSIX 系統呼叫
- `sys/ioctl.h`: 終端尺寸查詢（可選）

## 開發注意事項

- 所有註釋使用繁體中文
- 使用安全的字串函數（strnlen, snprintf, strncpy）
- 所有路徑操作前必須進行路徑遍歷檢查
- 記憶體分配後必須檢查返回值
- 使用後必須釋放記憶體，避免洩漏
- 文件系統數據使用 ChaCha20 加密存檔，密鑰為 "yunhongisbest"

## 數據檔案

文件系統數據保存在 `.yunfs_data` 檔案中，使用 ChaCha20 加密。該檔案會在以下情況自動更新：

- 退出 shell 時自動保存
- 啟動時自動載入（如果檔案存在）
