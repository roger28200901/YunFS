/**
 * @file sanitize.h
 * @brief 路徑清理與規範化模組標頭檔
 *
 * 本模組提供路徑字串的安全處理功能，包含：
 * - 移除危險字元
 * - 路徑規範化（移除重複斜線、處理 . 與 ..）
 * - 路徑遍歷攻擊檢測
 * - 安全的路徑連接
 *
 * @author Yun
 * @date 2025
 */

#ifndef SANITIZE_H
#define SANITIZE_H

#include <stddef.h>
#include <stdbool.h>

/* ========================================================================
 * 路徑清理函式
 * ======================================================================== */

/**
 * @brief 清理路徑中的危險字元
 *
 * 移除路徑中不允許的字元，僅保留：
 * - 英文字母與數字
 * - 斜線、點號、連字號、底線、空格
 *
 * @param path 原始路徑字串
 * @return 清理後的路徑（需由呼叫者釋放），失敗回傳 NULL
 */
char *sanitize_path(const char *path);

/**
 * @brief 規範化路徑
 *
 * 處理路徑中的冗餘元素：
 * - 移除重複的斜線
 * - 移除結尾的斜線（根目錄除外）
 *
 * @param path 原始路徑字串
 * @return 規範化後的路徑（需由呼叫者釋放），失敗回傳 NULL
 *
 * @note 若偵測到路徑遍歷攻擊會回傳 NULL
 */
char *normalize_path(const char *path);

/* ========================================================================
 * 安全性檢查函式
 * ======================================================================== */

/**
 * @brief 檢查路徑是否包含路徑遍歷攻擊
 *
 * 偵測常見的路徑遍歷模式：
 * - "../" 序列
 * - 以 ".." 開頭
 * - "/../" 序列
 *
 * @param path 路徑字串
 * @return true 偵測到攻擊，false 安全
 */
bool is_path_traversal(const char *path);

/* ========================================================================
 * 路徑處理函式
 * ======================================================================== */

/**
 * @brief 移除路徑中的重複斜線
 *
 * @param path 原始路徑字串
 * @return 處理後的路徑（需由呼叫者釋放），失敗回傳 NULL
 */
char *remove_duplicate_slashes(const char *path);

/**
 * @brief 安全地連接兩個路徑
 *
 * 將基礎路徑與相對路徑連接，自動處理斜線。
 *
 * @param base 基礎路徑
 * @param path 要連接的路徑
 * @return 連接後的路徑（需由呼叫者釋放），失敗回傳 NULL
 *
 * @note 會檢查路徑遍歷攻擊與路徑長度限制
 */
char *safe_path_join(const char *base, const char *path);

#endif // SANITIZE_H
